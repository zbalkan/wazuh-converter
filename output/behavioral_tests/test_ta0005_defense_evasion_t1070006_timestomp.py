import unittest

from internal.logtest import LogtestStatus, send_multiple_logs  # type: ignore


class TestTa0005DefenseEvasionT1070006Timestomp(unittest.TestCase):

    def test_id4616_system_time_changed(self) -> None:
        # Logs extracted from EVTX file
        logs = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-27T15:47:00.3656131Z", "eventRecordID": "19620789", "processID": "4", "threadID": "22320", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x934C5\n\nProcess Information:\n\tProcess ID:\t0x40fc\n\tName:\t\tC:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:47:00.388763900Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e27T15:47:00.369000000Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x934c5", "previousTime": "2021-11-24T15:47:00.3887639Z", "newTime": "2021-11-27T15:47:00.3690000Z", "processId": "0x40fc", "processName": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-27T15:47:00.3695503Z", "eventRecordID": "19620790", "processID": "4", "threadID": "22320", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x934C5\n\nProcess Information:\n\tProcess ID:\t0x40fc\n\tName:\t\tC:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e27T15:47:00.365663000Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e27T15:47:00.369000000Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x934c5", "previousTime": "2021-11-27T15:47:00.3656630Z", "newTime": "2021-11-27T15:47:00.3690000Z", "processId": "0x40fc", "processName": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-24T15:43:16.6576822Z", "eventRecordID": "19620793", "processID": "4", "threadID": "20628", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\nProcess Information:\n\tProcess ID:\t0x17c\n\tName:\t\tC:\\Windows\\System32\\svchost.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e27T15:47:00.465385500Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:43:16.657000000Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "previousTime": "2021-11-27T15:47:00.4653855Z", "newTime": "2021-11-24T15:43:16.6570000Z", "processId": "0x17c", "processName": "C:\\Windows\\System32\\svchost.exe"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-24T15:43:16.6534272Z", "eventRecordID": "19620794", "processID": "4", "threadID": "23440", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\nProcess Information:\n\tProcess ID:\t0x17c\n\tName:\t\tC:\\Windows\\System32\\svchost.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:43:16.659672000Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:43:16.656000000Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "previousTime": "2021-11-24T15:43:16.6596720Z", "newTime": "2021-11-24T15:43:16.6560000Z", "processId": "0x17c", "processName": "C:\\Windows\\System32\\svchost.exe"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-24T15:48:15.2108489Z", "eventRecordID": "19620900", "processID": "4", "threadID": "22320", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\nProcess Information:\n\tProcess ID:\t0x17c\n\tName:\t\tC:\\Windows\\System32\\svchost.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:05.022785300Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:15.210859500Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "previousTime": "2021-11-24T15:48:05.0227853Z", "newTime": "2021-11-24T15:48:15.2108595Z", "processId": "0x17c", "processName": "C:\\Windows\\System32\\svchost.exe"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-24T15:48:15.2104314Z", "eventRecordID": "19620901", "processID": "4", "threadID": "22320", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\nProcess Information:\n\tProcess ID:\t0x17c\n\tName:\t\tC:\\Windows\\System32\\svchost.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:15.210953300Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:15.210000000Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "previousTime": "2021-11-24T15:48:15.2109533Z", "newTime": "2021-11-24T15:48:15.2100000Z", "processId": "0x17c", "processName": "C:\\Windows\\System32\\svchost.exe"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-24T15:48:24.9854840Z", "eventRecordID": "19620903", "processID": "4", "threadID": "20628", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x934C5\n\nProcess Information:\n\tProcess ID:\t0x5924\n\tName:\t\tC:\\Windows\\System32\\dllhost.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:33.084791500Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:25.000000000Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x934c5", "previousTime": "2021-11-24T15:48:33.0847915Z", "newTime": "2021-11-24T15:48:25.0000000Z", "processId": "0x5924", "processName": "C:\\Windows\\System32\\dllhost.exe"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4616", "version": "1", "level": "0", "task": "12288", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-11-24T15:48:25.0002365Z", "eventRecordID": "19620904", "processID": "4", "threadID": "20628", "channel": "Security", "computer": "jump01.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "The system time was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x934C5\n\nProcess Information:\n\tProcess ID:\t0x5924\n\tName:\t\tC:\\Windows\\System32\\dllhost.exe\n\nPrevious Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:24.985521400Z\nNew Time:\t\t\u200e2021\u200e-\u200e11\u200e-\u200e24T15:48:25.000000000Z\n\nThis event is generated when the system time is changed. It is normal for the Windows Time Service, which runs with System privilege, to change the system time on a regular basis. Other system time changes may be indicative of attempts to tamper with the computer."}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x934c5", "previousTime": "2021-11-24T15:48:24.9855214Z", "newTime": "2021-11-24T15:48:25.0000000Z", "processId": "0x5924", "processName": "C:\\Windows\\System32\\dllhost.exe"}}}'''
        ]

        responses = send_multiple_logs(logs, location="stdin", log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        for _, response in enumerate(responses):
            self.assertEqual(response.status, LogtestStatus.RuleMatch)
            self.assertEqual(response.decoder, 'json')

            # Example: Set expected Wazuh rule ID and level when analyzing logs
            # expected_rule_id = None  # Replace with actual rule ID
            # expected_rule_level = None  # Replace with actual rule level

            # self.assertEqual(response.rule_id, expected_rule_id)
            # self.assertEqual(response.rule_level, expected_rule_level)

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")
