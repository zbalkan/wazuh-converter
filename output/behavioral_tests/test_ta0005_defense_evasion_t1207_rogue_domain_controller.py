import unittest

from internal.logtest import LogtestStatus, send_multiple_logs  # type: ignore


class TestTa0005DefenseEvasionT1207RogueDomainController(unittest.TestCase):

    def test_id4662_sensitive_attributes_accessed_dcshadow(self) -> None:
        # Logs extracted from EVTX file
        logs = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:41:38.7711238Z", "eventRecordID": "125592801", "processID": "560", "threadID": "608", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x882D87\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{f780acc0-56f0-11d1-a9c6-0000f80367c1}\n\tObject Name:\t\t%{665d6fdb-b06f-4d36-9da5-9b8dbaafeb2a}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tCreate Child\n\t\t\t\t\n\tAccess Mask:\t\t0x1\n\tProperties:\t\tCreate Child\n\t{bf967a92-0de6-11d0-a285-00aa003049e2}\n\n\nAdditional Information:\n\tParameter 1:\t\tCN=JUMP01,CN=Servers,CN=OFFSEC-PREMISE,CN=Sites,CN=Configuration,DC=offsec,DC=lan\n\tParameter 2:\t\t%{2cb2fa54-a21a-4e2f-b7af-a82a56d9d690}"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x882d87", "objectServer": "DS", "objectType": "%{f780acc0-56f0-11d1-a9c6-0000f80367c1}", "objectName": "%{665d6fdb-b06f-4d36-9da5-9b8dbaafeb2a}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7680", "accessMask": "0x1", "properties": "%%7680\n\t{bf967a92-0de6-11d0-a285-00aa003049e2}", "additionalInfo": "CN=JUMP01,CN=Servers,CN=OFFSEC-PREMISE,CN=Sites,CN=Configuration,DC=offsec,DC=lan", "additionalInfo2": "%{2cb2fa54-a21a-4e2f-b7af-a82a56d9d690}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:41:38.9888980Z", "eventRecordID": "125592807", "processID": "560", "threadID": "608", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x882E4A\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{19195a5b-6da0-11d0-afd3-00c04fd930c9}\n\tObject Name:\t\t%{0b32719a-29a5-4ad5-b9dc-56200eba0ce0}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t\t{9923a32a-3607-11d2-b9be-0000f87a36b2}\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x882e4a", "objectServer": "DS", "objectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}", "objectName": "%{0b32719a-29a5-4ad5-b9dc-56200eba0ce0}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t\t{9923a32a-3607-11d2-b9be-0000f87a36b2}\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:41:39.0169040Z", "eventRecordID": "125592809", "processID": "560", "threadID": "3376", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x882E4A\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{19195a5b-6da0-11d0-afd3-00c04fd930c9}\n\tObject Name:\t\t%{0b32719a-29a5-4ad5-b9dc-56200eba0ce0}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t\t{1131f6ac-9c07-11d1-f79f-00c04fc2dcd2}\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x882e4a", "objectServer": "DS", "objectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}", "objectName": "%{0b32719a-29a5-4ad5-b9dc-56200eba0ce0}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t\t{1131f6ac-9c07-11d1-f79f-00c04fc2dcd2}\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:42:21.0970922Z", "eventRecordID": "125592907", "processID": "560", "threadID": "2248", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x882E4A\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{19195a5b-6da0-11d0-afd3-00c04fd930c9}\n\tObject Name:\t\t%{0b32719a-29a5-4ad5-b9dc-56200eba0ce0}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t\t{1131f6ac-9c07-11d1-f79f-00c04fc2dcd2}\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x882e4a", "objectServer": "DS", "objectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}", "objectName": "%{0b32719a-29a5-4ad5-b9dc-56200eba0ce0}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t\t{1131f6ac-9c07-11d1-f79f-00c04fc2dcd2}\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:42:21.1038668Z", "eventRecordID": "125592909", "processID": "560", "threadID": "2248", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x882D87\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{f0f8ffab-1191-11d0-a060-00aa006c33ed}\n\tObject Name:\t\t%{097b2e16-f2c3-44ef-b300-ec7e11e2a9f2}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tDELETE\n\t\t\t\t\n\tAccess Mask:\t\t0x10000\n\tProperties:\t\tDELETE\n\t{f0f8ffab-1191-11d0-a060-00aa006c33ed}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x882d87", "objectServer": "DS", "objectType": "%{f0f8ffab-1191-11d0-a060-00aa006c33ed}", "objectName": "%{097b2e16-f2c3-44ef-b300-ec7e11e2a9f2}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%1537", "accessMask": "0x10000", "properties": "%%1537\n\t{f0f8ffab-1191-11d0-a060-00aa006c33ed}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:42:21.1320941Z", "eventRecordID": "125592910", "processID": "560", "threadID": "3376", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x882D87\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a92-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{2cb2fa54-a21a-4e2f-b7af-a82a56d9d690}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tDELETE\n\t\t\t\t\n\tAccess Mask:\t\t0x10000\n\tProperties:\t\tDELETE\n\t{bf967a92-0de6-11d0-a285-00aa003049e2}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x882d87", "objectServer": "DS", "objectType": "%{bf967a92-0de6-11d0-a285-00aa003049e2}", "objectName": "%{2cb2fa54-a21a-4e2f-b7af-a82a56d9d690}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%1537", "accessMask": "0x10000", "properties": "%%1537\n\t{bf967a92-0de6-11d0-a285-00aa003049e2}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:42:48.2193068Z", "eventRecordID": "125592984", "processID": "560", "threadID": "652", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x88659C\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x88659c", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:42:48.2313099Z", "eventRecordID": "125592988", "processID": "560", "threadID": "3376", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x886718\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x886718", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:42:48.6898665Z", "eventRecordID": "125593032", "processID": "560", "threadID": "3376", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x88793F\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x88793f", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:42:48.7015873Z", "eventRecordID": "125593036", "processID": "560", "threadID": "3376", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x887ABB\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x887abb", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:47:48.9458366Z", "eventRecordID": "125594504", "processID": "560", "threadID": "3376", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x8991A8\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x8991a8", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:47:48.9584573Z", "eventRecordID": "125594508", "processID": "560", "threadID": "2248", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x899324\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x899324", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:47:49.4325749Z", "eventRecordID": "125594551", "processID": "560", "threadID": "608", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x89A582\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x89a582", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4662", "version": "0", "level": "0", "task": "14080", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:47:49.4452486Z", "eventRecordID": "125594555", "processID": "560", "threadID": "608", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "An operation was performed on an object.\n\nSubject :\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x89A6FE\n\nObject:\n\tObject Server:\t\tDS\n\tObject Type:\t\t%{bf967a86-0de6-11d0-a285-00aa003049e2}\n\tObject Name:\t\t%{832b1c45-2f6e-4c82-be40-d461e377f560}\n\tHandle ID:\t\t0x0\n\nOperation:\n\tOperation Type:\t\tObject Access\n\tAccesses:\t\tControl Access\n\t\t\t\t\n\tAccess Mask:\t\t0x100\n\tProperties:\t\tControl Access\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}\n\n\nAdditional Information:\n\tParameter 1:\t\t-\n\tParameter 2:"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x89a6fe", "objectServer": "DS", "objectType": "%{bf967a86-0de6-11d0-a285-00aa003049e2}", "objectName": "%{832b1c45-2f6e-4c82-be40-d461e377f560}", "operationType": "Object Access", "handleId": "0x0", "accessList": "%%7688", "accessMask": "0x100", "properties": "%%7688\n\t{bf967a86-0de6-11d0-a285-00aa003049e2}\n\t\t{91e647de-d96f-4b70-9557-d63ff4f3ccd8}\n\t\t\t{6617e4ac-a2f1-43ab-b60c-11fbd1facf05}\n\t\t\t{b3f93023-9239-4f7c-b99c-6745d87adbc2}\n\t\t\t{b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7}\n\t\t\t{b7ff5a38-0818-42b0-8110-d3d154c97f24}\n\t\t{771727b1-31b8-4cdf-ae62-4fe39fadf89e}\n\t\t\t{aa4e1a6d-550d-4e05-8c35-4afcb917a9fe}\n\t\t\t{612cb747-c0e8-4f92-9221-fdd5f15b550d}"}}}'''
        ]

        responses = send_multiple_logs(logs, location="stdin", log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        for _, response in enumerate(responses):
            self.assertEqual(response.status, LogtestStatus.RuleMatch)
            self.assertEqual(response.decoder, 'json')

            # Example: Set expected Wazuh rule ID and level when analyzing logs
            # expected_rule_id = None  # Replace with actual rule ID
            # expected_rule_level = None  # Replace with actual rule level

            # self.assertEqual(response.rule_id, expected_rule_id)
            # self.assertEqual(response.rule_level, expected_rule_level)

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")

    def test_id5137_fake_domain_controller_registration_dcshadow(self) -> None:
        # Logs extracted from EVTX file
        logs = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5137", "version": "0", "level": "0", "task": "14081", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-03-26T20:41:48.2464912Z", "eventRecordID": "125592824", "processID": "560", "threadID": "608", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A directory service object was created.\n\t\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x882D87\n\t\nDirectory Service:\n\tName:\toffsec.lan\n\tType:\tActive Directory Domain Services\n\t\nObject:\n\tDN:\tCN=JUMP01,CN=Servers,CN=OFFSEC-PREMISE,CN=Sites,CN=Configuration,DC=offsec,DC=lan\n\tGUID:\t{2cb2fa54-a21a-4e2f-b7af-a82a56d9d690}\n\tClass:\tserver\n\t\nOperation:\n\tCorrelation ID:\t{4dea43cc-2e4b-41d8-842e-b4052ed0839e}\n\tApplication Correlation ID:\t-"}, "eventdata": {"opCorrelationID": "{4dea43cc-2e4b-41d8-842e-b4052ed0839e}", "subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x882d87", "dSName": "offsec.lan", "dSType": "%%14676", "objectDN": "CN=JUMP01,CN=Servers,CN=OFFSEC-PREMISE,CN=Sites,CN=Configuration,DC=offsec,DC=lan", "objectGUID": "{2cb2fa54-a21a-4e2f-b7af-a82a56d9d690}", "objectClass": "server"}}}'''
        ]

        responses = send_multiple_logs(logs, location="stdin", log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        for _, response in enumerate(responses):
            self.assertEqual(response.status, LogtestStatus.RuleMatch)
            self.assertEqual(response.decoder, 'json')

            # Example: Set expected Wazuh rule ID and level when analyzing logs
            # expected_rule_id = None  # Replace with actual rule ID
            # expected_rule_level = None  # Replace with actual rule level

            # self.assertEqual(response.rule_id, expected_rule_id)
            # self.assertEqual(response.rule_level, expected_rule_level)

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")
