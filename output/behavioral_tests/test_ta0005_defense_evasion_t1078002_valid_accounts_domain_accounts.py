import unittest

from internal.logtest import LogtestStatus, send_multiple_logs  # type: ignore


class TestTa0005DefenseEvasionT1078002ValidAccountsDomainAccounts(unittest.TestCase):

    def test_id4964_login_of_a_member_of_a_special_group(self) -> None:
        # Logs extracted from EVTX file
        logs = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:01:42.2411354Z", "eventRecordID": "16088306", "processID": "528", "threadID": "2796", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80E3882\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80e3882", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:01:57.7042143Z", "eventRecordID": "16089306", "processID": "528", "threadID": "3836", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x3E7\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80E977E\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80e977e", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:01:57.7092890Z", "eventRecordID": "16089314", "processID": "528", "threadID": "3836", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x3E7\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80E9795\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80e9795", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:01:57.7100373Z", "eventRecordID": "16089318", "processID": "528", "threadID": "3836", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x3E7\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80E97A8\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80e97a8", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:01:57.7106245Z", "eventRecordID": "16089322", "processID": "528", "threadID": "3836", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-18\n\tAccount Name:\t\tROOTDC1$\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x3E7\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80E97BA\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-18", "subjectUserName": "ROOTDC1$", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x3e7", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80e97ba", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:02:23.1668467Z", "eventRecordID": "16089367", "processID": "528", "threadID": "3468", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80E9FA1\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80e9fa1", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:02:23.1952514Z", "eventRecordID": "16089380", "processID": "528", "threadID": "3468", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80EA061\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80ea061", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4964", "version": "0", "level": "0", "task": "12548", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2020-07-12T06:03:28.5909653Z", "eventRecordID": "16089548", "processID": "528", "threadID": "3468", "channel": "Security", "computer": "rootdc1.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "Special groups have been assigned to a new logon.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-19\n\tAccount Name:\t\tLOCAL SERVICE\n\tAccount Domain:\t\tNT AUTHORITY\n\tLogon ID:\t\t0x3E5\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\nNew Logon:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x80EB079\n\tLogon GUID:\t{00000000-0000-0000-0000-000000000000}\n\tSpecial Groups Assigned:\t\n\t\t%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}, "eventdata": {"subjectUserSid": "S-1-5-19", "subjectUserName": "LOCAL SERVICE", "subjectDomainName": "NT AUTHORITY", "subjectLogonId": "0x3e5", "logonGuid": "{00000000-0000-0000-0000-000000000000}", "targetUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "targetUserName": "admmig", "targetDomainName": "OFFSEC", "targetLogonId": "0x80eb079", "targetLogonGuid": "{00000000-0000-0000-0000-000000000000}", "sidList": "%{S-1-5-21-4230534742-2542757381-3142984815-1613}"}}}'''
        ]

        responses = send_multiple_logs(logs, location="stdin", log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        for _, response in enumerate(responses):
            self.assertEqual(response.status, LogtestStatus.RuleMatch)
            self.assertEqual(response.decoder, 'json')

            # Example: Set expected Wazuh rule ID and level when analyzing logs
            # expected_rule_id = None  # Replace with actual rule ID
            # expected_rule_level = None  # Replace with actual rule level

            # self.assertEqual(response.rule_id, expected_rule_id)
            # self.assertEqual(response.rule_level, expected_rule_level)

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")
