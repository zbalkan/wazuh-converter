import unittest

from internal.logtest import LogtestStatus, send_multiple_logs  # type: ignore


class TestTa0004PrivilegeEscalationT1484DomainOrTenantPolicyModification(unittest.TestCase):

    def test_id_4865_4706_trust_added(self) -> None:
        # Logs extracted from EVTX file
        logs = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4741", "version": "0", "level": "0", "task": "13825", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2024-06-22T14:02:41.6203738Z", "eventRecordID": "3175608", "processID": "596", "threadID": "11064", "channel": "Security", "computer": "CDCWTRDC01.mypartner.lan", "severityValue": "AUDIT_SUCCESS", "message": "A computer account was created.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-500\n\tAccount Name:\t\tAdministrator\n\tAccount Domain:\t\tMYPARTNER\n\tLogon ID:\t\t0xFFAD8559\n\nNew Computer Account:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-1109\n\tAccount Name:\t\tROOTBLUE$\n\tAccount Domain:\t\tMYPARTNER\n\nAttributes:\n\tSAM Account Name:\tROOTBLUE$\n\tDisplay Name:\t\t<value not set>\n\tUser Principal Name:\t-\n\tHome Directory:\t\t<value not set>\n\tHome Drive:\t\t<value not set>\n\tScript Path:\t\t<value not set>\n\tProfile Path:\t\t<value not set>\n\tUser Workstations:\t<value not set>\n\tPassword Last Set:\t<never>\n\tAccount Expires:\t\t<never>\n\tPrimary Group ID:\t513\n\tAllowedToDelegateTo:\t-\n\tOld UAC Value:\t\t0x0\n\tNew UAC Value:\t\t0x45\n\tUser Account Control:\t\n\t\tAccount Disabled\n\t\t'Password Not Required' - Enabled\n\t\t'Interdomain Trust Account' - Enabled\n\tUser Parameters:\t<value changed, but not displayed>\n\tSID History:\t\t-\n\tLogon Hours:\t\t<value not set>\n\tDNS Host Name:\t\t-\n\tService Principal Names:\t-\n\nAdditional Information:\n\tPrivileges\t\t-"}, "eventdata": {"targetUserName": "ROOTBLUE$", "targetDomainName": "MYPARTNER", "targetSid": "S-1-5-21-1407145384-2259788832-4099636412-1109", "subjectUserSid": "S-1-5-21-1407145384-2259788832-4099636412-500", "subjectUserName": "Administrator", "subjectDomainName": "MYPARTNER", "subjectLogonId": "0xffad8559", "samAccountName": "ROOTBLUE$", "displayName": "%%1793", "homeDirectory": "%%1793", "homePath": "%%1793", "scriptPath": "%%1793", "profilePath": "%%1793", "userWorkstations": "%%1793", "passwordLastSet": "%%1794", "accountExpires": "%%1794", "primaryGroupId": "513", "oldUacValue": "0x0", "newUacValue": "0x45", "userAccountControl": "%%2080\n\t\t%%2082\n\t\t%%2086", "userParameters": "%%1792", "logonHours": "%%1793"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4742", "version": "0", "level": "0", "task": "13825", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2024-06-22T14:02:41.6391095Z", "eventRecordID": "3175611", "processID": "596", "threadID": "11064", "channel": "Security", "computer": "CDCWTRDC01.mypartner.lan", "severityValue": "AUDIT_SUCCESS", "message": "A computer account was changed.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-500\n\tAccount Name:\t\tAdministrator\n\tAccount Domain:\t\tMYPARTNER\n\tLogon ID:\t\t0xFFAD8559\n\nComputer Account That Was Changed:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-1109\n\tAccount Name:\t\tROOTBLUE$\n\tAccount Domain:\t\tMYPARTNER\n\nChanged Attributes:\n\tSAM Account Name:\t-\n\tDisplay Name:\t\t-\n\tUser Principal Name:\t-\n\tHome Directory:\t\t-\n\tHome Drive:\t\t-\n\tScript Path:\t\t-\n\tProfile Path:\t\t-\n\tUser Workstations:\t-\n\tPassword Last Set:\t22.06.2024 16:02:41\n\tAccount Expires:\t\t-\n\tPrimary Group ID:\t-\n\tAllowedToDelegateTo:\t-\n\tOld UAC Value:\t\t0x45\n\tNew UAC Value:\t\t0x44\n\tUser Account Control:\t\n\t\tAccount Enabled\n\tUser Parameters:\t-\n\tSID History:\t\t-\n\tLogon Hours:\t\t-\n\tDNS Host Name:\t\t-\n\tService Principal Names:\t-\n\nAdditional Information:\n\tPrivileges:\t\t-"}, "eventdata": {"targetUserName": "ROOTBLUE$", "targetDomainName": "MYPARTNER", "targetSid": "S-1-5-21-1407145384-2259788832-4099636412-1109", "subjectUserSid": "S-1-5-21-1407145384-2259788832-4099636412-500", "subjectUserName": "Administrator", "subjectDomainName": "MYPARTNER", "subjectLogonId": "0xffad8559", "passwordLastSet": "22.06.2024 16:02:41", "oldUacValue": "0x45", "newUacValue": "0x44", "userAccountControl": "%%2048"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4706", "version": "0", "level": "0", "task": "13569", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2024-06-22T14:02:41.6391626Z", "eventRecordID": "3175612", "processID": "596", "threadID": "11064", "channel": "Security", "computer": "CDCWTRDC01.mypartner.lan", "severityValue": "AUDIT_SUCCESS", "message": "A new trust was created to a domain.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-500\n\tAccount Name:\t\tAdministrator\n\tAccount Domain:\t\tMYPARTNER\n\tLogon ID:\t\t0xFFAD8559\n\nTrusted Domain:\n\tDomain Name:\t\trootblue.lan\n\tDomain ID:\t\tS-1-5-21-392370121-190461309-2151315433\n\nTrust Information:\n\tTrust Type:\t\t2\n\tTrust Direction:\t\t3\n\tTrust Attributes:\t\t8\n\tSID Filtering:\t\tDisabled"}, "eventdata": {"domainName": "rootblue.lan", "domainSid": "S-1-5-21-392370121-190461309-2151315433", "subjectUserSid": "S-1-5-21-1407145384-2259788832-4099636412-500", "subjectUserName": "Administrator", "subjectDomainName": "MYPARTNER", "subjectLogonId": "0xffad8559", "tdoType": "2", "tdoDirection": "3", "tdoAttributes": "8", "sidFilteringEnabled": "%%1796"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4865", "version": "0", "level": "0", "task": "13569", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2024-06-22T14:02:41.7499354Z", "eventRecordID": "3175613", "processID": "596", "threadID": "3360", "channel": "Security", "computer": "CDCWTRDC01.mypartner.lan", "severityValue": "AUDIT_SUCCESS", "message": "A trusted forest information entry was added.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-500\n\tAccount Name:\t\tAdministrator\n\tAccount Domain:\t\tMYPARTNER\n\tLogon ID:\t\t0xFFAD8559\n\nTrust Information:\n\tForest Root:\trootblue.lan\n\tForest Root SID:\tS-1-5-21-392370121-190461309-2151315433\n\tOperation ID:\t0xFFADF358\n\tEntry Type:\t0\n\tFlags:\t0\n\tTop Level Name:\trootblue.lan\n\tDNS Name:\t-\n\tNetBIOS Name:\t-\n\tDomain SID:\tS-1-0-0"}, "eventdata": {"forestRoot": "rootblue.lan", "forestRootSid": "S-1-5-21-392370121-190461309-2151315433", "operationId": "0xffadf358", "entryType": "0", "flags": "0", "topLevelName": "rootblue.lan", "domainSid": "S-1-0-0", "subjectUserSid": "S-1-5-21-1407145384-2259788832-4099636412-500", "subjectUserName": "Administrator", "subjectDomainName": "MYPARTNER", "subjectLogonId": "0xffad8559"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4865", "version": "0", "level": "0", "task": "13569", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2024-06-22T14:02:41.7499484Z", "eventRecordID": "3175614", "processID": "596", "threadID": "3360", "channel": "Security", "computer": "CDCWTRDC01.mypartner.lan", "severityValue": "AUDIT_SUCCESS", "message": "A trusted forest information entry was added.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-500\n\tAccount Name:\t\tAdministrator\n\tAccount Domain:\t\tMYPARTNER\n\tLogon ID:\t\t0xFFAD8559\n\nTrust Information:\n\tForest Root:\trootblue.lan\n\tForest Root SID:\tS-1-5-21-392370121-190461309-2151315433\n\tOperation ID:\t0xFFADF358\n\tEntry Type:\t2\n\tFlags:\t0\n\tTop Level Name:\t-\n\tDNS Name:\tchild.rootblue.lan\n\tNetBIOS Name:\tCHILD\n\tDomain SID:\tS-1-5-21-2047893623-4037909379-2884207733"}, "eventdata": {"forestRoot": "rootblue.lan", "forestRootSid": "S-1-5-21-392370121-190461309-2151315433", "operationId": "0xffadf358", "entryType": "2", "flags": "0", "dnsName": "child.rootblue.lan", "netbiosName": "CHILD", "domainSid": "S-1-5-21-2047893623-4037909379-2884207733", "subjectUserSid": "S-1-5-21-1407145384-2259788832-4099636412-500", "subjectUserName": "Administrator", "subjectDomainName": "MYPARTNER", "subjectLogonId": "0xffad8559"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "4865", "version": "0", "level": "0", "task": "13569", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2024-06-22T14:02:41.7499595Z", "eventRecordID": "3175615", "processID": "596", "threadID": "3360", "channel": "Security", "computer": "CDCWTRDC01.mypartner.lan", "severityValue": "AUDIT_SUCCESS", "message": "A trusted forest information entry was added.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-1407145384-2259788832-4099636412-500\n\tAccount Name:\t\tAdministrator\n\tAccount Domain:\t\tMYPARTNER\n\tLogon ID:\t\t0xFFAD8559\n\nTrust Information:\n\tForest Root:\trootblue.lan\n\tForest Root SID:\tS-1-5-21-392370121-190461309-2151315433\n\tOperation ID:\t0xFFADF358\n\tEntry Type:\t2\n\tFlags:\t0\n\tTop Level Name:\t-\n\tDNS Name:\trootblue.lan\n\tNetBIOS Name:\tROOTBLUE\n\tDomain SID:\tS-1-5-21-392370121-190461309-2151315433"}, "eventdata": {"forestRoot": "rootblue.lan", "forestRootSid": "S-1-5-21-392370121-190461309-2151315433", "operationId": "0xffadf358", "entryType": "2", "flags": "0", "dnsName": "rootblue.lan", "netbiosName": "ROOTBLUE", "domainSid": "S-1-5-21-392370121-190461309-2151315433", "subjectUserSid": "S-1-5-21-1407145384-2259788832-4099636412-500", "subjectUserName": "Administrator", "subjectDomainName": "MYPARTNER", "subjectLogonId": "0xffad8559"}}}'''
        ]

        responses = send_multiple_logs(logs, location="stdin", log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        for _, response in enumerate(responses):
            self.assertEqual(response.status, LogtestStatus.RuleMatch)
            self.assertEqual(response.decoder, 'json')

            # Example: Set expected Wazuh rule ID and level when analyzing logs
            # expected_rule_id = None  # Replace with actual rule ID
            # expected_rule_level = None  # Replace with actual rule level

            # self.assertEqual(response.rule_id, expected_rule_id)
            # self.assertEqual(response.rule_level, expected_rule_level)

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")
