import unittest

from internal.logtest import LogtestStatus, send_multiple_logs  # type: ignore


class TestTa0005DefenseEvasionT1555004WindowsCredentialManager(unittest.TestCase):

    def test_id_5376_5379_5382_5381_5382_credential_manager_and_vault(self) -> None:
        # Logs extracted from EVTX file
        logs = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5379", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:53:36.3275228Z", "eventRecordID": "149979", "processID": "804", "threadID": "9188", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Credential Manager credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\tRead Operation:\t\tEnumerate Credentials\n\nThis event occurs when a user performs a read operation on stored credentials in Credential Manager."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "type": "0", "countOfCredentialsReturned": "9", "readOperation": "%%8100", "returnCode": "0", "processCreationTime": "2022-09-23T18:02:59.9739011Z", "clientProcessId": "804"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5381", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:53:36.3280065Z", "eventRecordID": "149980", "processID": "804", "threadID": "920", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\nThis event occurs when a user enumerates stored vault credentials."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "flags": "512", "countOfCredentialsReturned": "0", "processCreationTime": "2022-09-24T19:52:46.5952970Z", "clientProcessId": "12440"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5379", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:53:36.3283150Z", "eventRecordID": "149981", "processID": "804", "threadID": "920", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Credential Manager credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\tRead Operation:\t\tEnumerate Credentials\n\nThis event occurs when a user performs a read operation on stored credentials in Credential Manager."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "type": "0", "countOfCredentialsReturned": "9", "readOperation": "%%8100", "returnCode": "0", "processCreationTime": "2022-09-24T19:52:46.5952970Z", "clientProcessId": "12440"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5379", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:53:50.7481218Z", "eventRecordID": "149982", "processID": "804", "threadID": "9188", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Credential Manager credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\tRead Operation:\t\tEnumerate Credentials\n\nThis event occurs when a user performs a read operation on stored credentials in Credential Manager."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "type": "0", "countOfCredentialsReturned": "9", "readOperation": "%%8100", "returnCode": "0", "processCreationTime": "2022-09-23T18:02:59.9739011Z", "clientProcessId": "804"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5381", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:53:50.7485960Z", "eventRecordID": "149983", "processID": "804", "threadID": "920", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\nThis event occurs when a user enumerates stored vault credentials."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "flags": "512", "countOfCredentialsReturned": "0", "processCreationTime": "2022-09-24T19:52:46.5952970Z", "clientProcessId": "12440"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5379", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:53:50.7489074Z", "eventRecordID": "149984", "processID": "804", "threadID": "920", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Credential Manager credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\tRead Operation:\t\tEnumerate Credentials\n\nThis event occurs when a user performs a read operation on stored credentials in Credential Manager."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "type": "0", "countOfCredentialsReturned": "9", "readOperation": "%%8100", "returnCode": "0", "processCreationTime": "2022-09-24T19:52:46.5952970Z", "clientProcessId": "12440"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5381", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:55:48.2868394Z", "eventRecordID": "149992", "processID": "804", "threadID": "5788", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1005\n\tAccount Name:\t\tadmin\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0x5BCC667\n\nThis event occurs when a user enumerates stored vault credentials."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1005", "subjectUserName": "admin", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0x5bcc667", "flags": "0", "countOfCredentialsReturned": "0", "processCreationTime": "2022-09-24T19:42:45.4113715Z", "clientProcessId": "7756"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5379", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:55:55.0144128Z", "eventRecordID": "149994", "processID": "804", "threadID": "5788", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Credential Manager credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\tRead Operation:\t\tEnumerate Credentials\n\nThis event occurs when a user performs a read operation on stored credentials in Credential Manager."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "targetName": "MicrosoftOffice16_Data:live:cid=*", "type": "0", "countOfCredentialsReturned": "0", "readOperation": "%%8100", "returnCode": "3221226021", "processCreationTime": "2022-09-24T19:55:53.6398676Z", "clientProcessId": "2912"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5381", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:56:35.5014491Z", "eventRecordID": "149997", "processID": "804", "threadID": "5788", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1005\n\tAccount Name:\t\tadmin\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0x5BCC667\n\nThis event occurs when a user enumerates stored vault credentials."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1005", "subjectUserName": "admin", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0x5bcc667", "flags": "0", "countOfCredentialsReturned": "0", "processCreationTime": "2022-09-24T19:42:45.4113715Z", "clientProcessId": "7756"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5381", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:56:42.1800455Z", "eventRecordID": "149998", "processID": "804", "threadID": "5788", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1005\n\tAccount Name:\t\tadmin\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0x5BCC667\n\nThis event occurs when a user enumerates stored vault credentials."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1005", "subjectUserName": "admin", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0x5bcc667", "flags": "0", "countOfCredentialsReturned": "0", "processCreationTime": "2022-09-24T19:42:45.4113715Z", "clientProcessId": "7756"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5376", "version": "1", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T19:57:32.2662656Z", "eventRecordID": "150002", "processID": "804", "threadID": "5832", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Credential Manager credentials were backed up.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\tBackupFileName:\t\tC:\\Windows\\TEMP\\CRD46C3.tmp\n\nThis event occurs when a user backs up their own Credential Manager credentials. A user (even an Administrator) cannot back up the credentials of an account other than his own."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "backupFileName": "C:\\Windows\\TEMP\\CRD46C3.tmp", "processCreationTime": "2022-09-24T19:57:27.1706608Z", "clientProcessId": "5400"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5381", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T20:05:10.6985295Z", "eventRecordID": "150021", "processID": "804", "threadID": "920", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1005\n\tAccount Name:\t\tadmin\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0x5DA4731\n\nThis event occurs when a user enumerates stored vault credentials."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1005", "subjectUserName": "admin", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0x5da4731", "flags": "0", "countOfCredentialsReturned": "0", "processCreationTime": "2022-09-24T20:03:38.0255565Z", "clientProcessId": "8452"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5381", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T20:05:50.5717791Z", "eventRecordID": "150026", "processID": "804", "threadID": "5636", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\nThis event occurs when a user enumerates stored vault credentials."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "flags": "0", "countOfCredentialsReturned": "1", "processCreationTime": "2022-09-24T20:05:42.3177177Z", "clientProcessId": "10620"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5382", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T20:05:50.5944066Z", "eventRecordID": "150027", "processID": "804", "threadID": "5636", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Vault credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\nThis event occurs when a user reads a stored vault credential."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "schemaFriendlyName": "Windows Web Password Credential", "schema": "{3ccd5499-87a8-4b10-a215-608888dd3b55}", "resource": "https://login.live.com/", "identity": "m.decrevoisier@outlook.com", "flags": "0", "returnCode": "0", "processCreationTime": "2022-09-24T20:05:42.3177177Z", "clientProcessId": "10620"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5379", "version": "0", "level": "0", "task": "13824", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2022-09-24T20:06:33.3792222Z", "eventRecordID": "150034", "processID": "804", "threadID": "920", "channel": "Security", "computer": "GUAPOS-PC", "severityValue": "AUDIT_SUCCESS", "message": "Credential Manager credentials were read.\n\nSubject:\n\tSecurity ID:\t\tS-1-5-21-3960598978-2723104146-531989891-1001\n\tAccount Name:\t\tFOXTWO\n\tAccount Domain:\t\tGUAPOS-PC\n\tLogon ID:\t\t0xDA54B\n\tRead Operation:\t\tEnumerate Credentials\n\nThis event occurs when a user performs a read operation on stored credentials in Credential Manager."}, "eventdata": {"subjectUserSid": "S-1-5-21-3960598978-2723104146-531989891-1001", "subjectUserName": "FOXTWO", "subjectDomainName": "GUAPOS-PC", "subjectLogonId": "0xda54b", "targetName": "MicrosoftOffice16_Data:SSPI:*", "type": "0", "countOfCredentialsReturned": "0", "readOperation": "%%8100", "returnCode": "3221226021", "processCreationTime": "2022-09-24T20:06:33.1604297Z", "clientProcessId": "1312"}}}'''
        ]

        responses = send_multiple_logs(logs, location="stdin", log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        for _, response in enumerate(responses):
            self.assertEqual(response.status, LogtestStatus.RuleMatch)
            self.assertEqual(response.decoder, 'json')

            # Example: Set expected Wazuh rule ID and level when analyzing logs
            # expected_rule_id = None  # Replace with actual rule ID
            # expected_rule_level = None  # Replace with actual rule level

            # self.assertEqual(response.rule_id, expected_rule_id)
            # self.assertEqual(response.rule_level, expected_rule_level)

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")
