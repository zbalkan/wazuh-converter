import unittest

from internal.logtest import LogtestStatus, send_multiple_logs  # type: ignore


class TestTa0007DiscoveryT1018RemoteSystemDiscovery(unittest.TestCase):

    def test_id5145_dns_hosts_files_access_via_network_share(self) -> None:
        # Logs extracted from EVTX file
        logs = [
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5145", "version": "0", "level": "0", "task": "12811", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-12-13T08:21:30.7675301Z", "eventRecordID": "1176255", "processID": "480", "threadID": "488", "channel": "Security", "computer": "fs03vuln.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A network share object was checked to see whether client can be granted desired access.\n\t\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x8CA6E1D\n\nNetwork Information:\t\n\tObject Type:\t\tFile\n\tSource Address:\t\t10.23.23.9\n\tSource Port:\t\t58478\n\t\nShare Information:\n\tShare Name:\t\t\\\\*\\C$\n\tShare Path:\t\t\\??\\C:\\\n\tRelative Target Name:\tWINDOWS\\SYSTEM32\\DRIVERS\\ETC\n\nAccess Request Information:\n\tAccess Mask:\t\t0x100081\n\tAccesses:\t\tSYNCHRONIZE\n\t\t\t\tReadData (or ListDirectory)\n\t\t\t\tReadAttributes\n\t\t\t\t\nAccess Check Results:\n\t-"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x8ca6e1d", "objectType": "File", "ipAddress": "10.23.23.9", "ipPort": "58478", "shareName": "\\\\*\\C$", "shareLocalPath": "\\??\\C:\\", "relativeTargetName": "WINDOWS\\SYSTEM32\\DRIVERS\\ETC", "accessMask": "0x100081", "accessList": "%%1541\n\t\t\t\t%%4416\n\t\t\t\t%%4423"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5145", "version": "0", "level": "0", "task": "12811", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-12-13T08:21:30.7675301Z", "eventRecordID": "1176256", "processID": "480", "threadID": "488", "channel": "Security", "computer": "fs03vuln.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A network share object was checked to see whether client can be granted desired access.\n\t\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x8CA6E1D\n\nNetwork Information:\t\n\tObject Type:\t\tFile\n\tSource Address:\t\t10.23.23.9\n\tSource Port:\t\t58477\n\t\nShare Information:\n\tShare Name:\t\t\\\\*\\C$\n\tShare Path:\t\t\\??\\C:\\\n\tRelative Target Name:\t\\\n\nAccess Request Information:\n\tAccess Mask:\t\t0x100080\n\tAccesses:\t\tSYNCHRONIZE\n\t\t\t\tReadAttributes\n\t\t\t\t\nAccess Check Results:\n\t-"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x8ca6e1d", "objectType": "File", "ipAddress": "10.23.23.9", "ipPort": "58477", "shareName": "\\\\*\\C$", "shareLocalPath": "\\??\\C:\\", "relativeTargetName": "\\", "accessMask": "0x100080", "accessList": "%%1541\n\t\t\t\t%%4423"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5145", "version": "0", "level": "0", "task": "12811", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-12-13T08:21:30.7675301Z", "eventRecordID": "1176257", "processID": "480", "threadID": "488", "channel": "Security", "computer": "fs03vuln.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A network share object was checked to see whether client can be granted desired access.\n\t\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x8CA6E1D\n\nNetwork Information:\t\n\tObject Type:\t\tFile\n\tSource Address:\t\t10.23.23.9\n\tSource Port:\t\t58476\n\t\nShare Information:\n\tShare Name:\t\t\\\\*\\C$\n\tShare Path:\t\t\\??\\C:\\\n\tRelative Target Name:\tWindows\\System32\\Drivers\\etc\\hosts:Zone.Identifier\n\nAccess Request Information:\n\tAccess Mask:\t\t0x80\n\tAccesses:\t\tReadAttributes\n\t\t\t\t\nAccess Check Results:\n\t-"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x8ca6e1d", "objectType": "File", "ipAddress": "10.23.23.9", "ipPort": "58476", "shareName": "\\\\*\\C$", "shareLocalPath": "\\??\\C:\\", "relativeTargetName": "Windows\\System32\\Drivers\\etc\\hosts:Zone.Identifier", "accessMask": "0x80", "accessList": "%%4423"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5145", "version": "0", "level": "0", "task": "12811", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-12-13T08:21:30.8139156Z", "eventRecordID": "1176258", "processID": "480", "threadID": "488", "channel": "Security", "computer": "fs03vuln.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A network share object was checked to see whether client can be granted desired access.\n\t\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x8CA6E1D\n\nNetwork Information:\t\n\tObject Type:\t\tFile\n\tSource Address:\t\t10.23.23.9\n\tSource Port:\t\t58477\n\t\nShare Information:\n\tShare Name:\t\t\\\\*\\C$\n\tShare Path:\t\t\\??\\C:\\\n\tRelative Target Name:\tWindows\\System32\n\nAccess Request Information:\n\tAccess Mask:\t\t0x100081\n\tAccesses:\t\tSYNCHRONIZE\n\t\t\t\tReadData (or ListDirectory)\n\t\t\t\tReadAttributes\n\t\t\t\t\nAccess Check Results:\n\t-"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x8ca6e1d", "objectType": "File", "ipAddress": "10.23.23.9", "ipPort": "58477", "shareName": "\\\\*\\C$", "shareLocalPath": "\\??\\C:\\", "relativeTargetName": "Windows\\System32", "accessMask": "0x100081", "accessList": "%%1541\n\t\t\t\t%%4416\n\t\t\t\t%%4423"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5145", "version": "0", "level": "0", "task": "12811", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-12-13T08:21:30.8295427Z", "eventRecordID": "1176259", "processID": "480", "threadID": "488", "channel": "Security", "computer": "fs03vuln.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A network share object was checked to see whether client can be granted desired access.\n\t\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x8CA6E1D\n\nNetwork Information:\t\n\tObject Type:\t\tFile\n\tSource Address:\t\t10.23.23.9\n\tSource Port:\t\t58479\n\t\nShare Information:\n\tShare Name:\t\t\\\\*\\C$\n\tShare Path:\t\t\\??\\C:\\\n\tRelative Target Name:\tWINDOWS\\SYSTEM32\\DRIVERS\n\nAccess Request Information:\n\tAccess Mask:\t\t0x100081\n\tAccesses:\t\tSYNCHRONIZE\n\t\t\t\tReadData (or ListDirectory)\n\t\t\t\tReadAttributes\n\t\t\t\t\nAccess Check Results:\n\t-"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x8ca6e1d", "objectType": "File", "ipAddress": "10.23.23.9", "ipPort": "58479", "shareName": "\\\\*\\C$", "shareLocalPath": "\\??\\C:\\", "relativeTargetName": "WINDOWS\\SYSTEM32\\DRIVERS", "accessMask": "0x100081", "accessList": "%%1541\n\t\t\t\t%%4416\n\t\t\t\t%%4423"}}}''',
            r'''{"win": {"system": {"providerName": "Microsoft-Windows-Security-Auditing", "providerGuid": "{54849625-5478-4994-a5ba-3e3b0328c30d}", "eventID": "5145", "version": "0", "level": "0", "task": "12811", "opcode": "0", "keywords": "0x8020000000000000", "systemTime": "2021-12-13T08:21:30.8451721Z", "eventRecordID": "1176260", "processID": "480", "threadID": "488", "channel": "Security", "computer": "fs03vuln.offsec.lan", "severityValue": "AUDIT_SUCCESS", "message": "A network share object was checked to see whether client can be granted desired access.\n\t\nSubject:\n\tSecurity ID:\t\tS-1-5-21-4230534742-2542757381-3142984815-1111\n\tAccount Name:\t\tadmmig\n\tAccount Domain:\t\tOFFSEC\n\tLogon ID:\t\t0x8CA6E1D\n\nNetwork Information:\t\n\tObject Type:\t\tFile\n\tSource Address:\t\t10.23.23.9\n\tSource Port:\t\t58478\n\t\nShare Information:\n\tShare Name:\t\t\\\\*\\C$\n\tShare Path:\t\t\\??\\C:\\\n\tRelative Target Name:\tWindows\\System32\\Drivers\\etc\n\nAccess Request Information:\n\tAccess Mask:\t\t0x100080\n\tAccesses:\t\tSYNCHRONIZE\n\t\t\t\tReadAttributes\n\t\t\t\t\nAccess Check Results:\n\t-"}, "eventdata": {"subjectUserSid": "S-1-5-21-4230534742-2542757381-3142984815-1111", "subjectUserName": "admmig", "subjectDomainName": "OFFSEC", "subjectLogonId": "0x8ca6e1d", "objectType": "File", "ipAddress": "10.23.23.9", "ipPort": "58478", "shareName": "\\\\*\\C$", "shareLocalPath": "\\??\\C:\\", "relativeTargetName": "Windows\\System32\\Drivers\\etc", "accessMask": "0x100080", "accessList": "%%1541\n\t\t\t\t%%4423"}}}'''
        ]

        responses = send_multiple_logs(logs, location="stdin", log_format="json")

        # Ensure we receive a response for each log sent
        self.assertEqual(len(responses), len(logs))

        for _, response in enumerate(responses):
            self.assertEqual(response.status, LogtestStatus.RuleMatch)
            self.assertEqual(response.decoder, 'json')

            # Example: Set expected Wazuh rule ID and level when analyzing logs
            # expected_rule_id = None  # Replace with actual rule ID
            # expected_rule_level = None  # Replace with actual rule level

            # self.assertEqual(response.rule_id, expected_rule_id)
            # self.assertEqual(response.rule_level, expected_rule_level)

        # TODO: Write the expected result as test cases when the logs are analyzed by Wazuh.
        self.fail("Test not implemented yet. Define expected results.")
